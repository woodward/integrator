defmodule Integrator.RungeKuttaTest do
  @moduledoc false
  use Integrator.TestCase

  import Nx, only: :sigils
  alias Integrator.RungeKutta

  describe "hermite_quartic_interpolation" do
    test "gives the correct result" do
      # Values from Octave:
      #
      # t = [ 19.4067624192,   19.7106968201 ]
      #
      #  x =
      #
      #    1.49652504841   1.92651431954
      #    2.10676183153   0.73529371547
      #
      #  der =
      #
      #     2.10676183153   1.85704689071   1.69384014677   1.09328301986   1.20767740745   1.06405291882   0.73529371547
      #    -4.10804009148  -4.66882299445  -4.71039008294  -4.47781878341  -4.51898062008  -4.30261858646  -3.92023192271
      #
      #  t_out = [ 19.4827460194,   19.5587296196, 19.6347132198,  19.7106968201 ]
      #
      #  x_out =
      #
      #   1.64398703647   1.76488148020   1.85862355568   1.92651431954
      #   1.77097584066   1.41075566029   1.05684789008   0.73529371547

      t = ~V[ 19.4067624192  19.7106968201 ]f64

      x = ~M[ 1.49652504841   1.92651431954
              2.10676183153   0.73529371547
            ]f64

      der = ~M[
           2.10676183153   1.85704689071   1.69384014677   1.09328301986   1.20767740745   1.06405291882   0.73529371547
          -4.10804009148  -4.66882299445  -4.71039008294  -4.47781878341  -4.51898062008  -4.30261858646  -3.92023192271
      ]f64

      t_out = ~V[ 19.4827460194  19.5587296196  19.6347132198  19.7106968201 ]f64

      expected_x_out = ~M[
        1.64398703647   1.76488148020   1.85862355568   1.92651431954
        1.77097584066   1.41075566029   1.05684789008   0.73529371547
      ]f64

      x_out = RungeKutta.hermite_quartic_interpolation(t, x, der, t_out)

      assert_all_close(x_out, expected_x_out, atol: 1.0e-9, rtol: 1.0e-9)
    end
  end
end
